"use strict";var _createClass=function(){function i(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(e,t,n){return t&&i(e.prototype,t),n&&i(e,n),e}}(),_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}"function"!=typeof Object.assign&&Object.defineProperty(Object,"assign",{value:function(e,t){if(null==e)throw new TypeError("Cannot convert undefined or null to object");for(var n=Object(e),i=1;i<arguments.length;i++){var s=arguments[i];if(null!=s)for(var r in s)Object.prototype.hasOwnProperty.call(s,r)&&(n[r]=s[r])}return n},writable:!0,configurable:!0}),Element.prototype.matches||function(e){var t=e.matches||e.matchesSelector||e.webkitMatchesSelector||e.mozMatchesSelector||e.msMatchesSelector||e.oMatchesSelector;e.matches=e.matchesSelector=t||function(e){var t=document.querySelectorAll(e),n=this;return Array.prototype.some.call(t,function(e){return e===n})}}(Element.prototype),Element.prototype.closest||function(e){e.matches=e.matches||e.mozMatchesSelector||e.msMatchesSelector||e.oMatchesSelector||e.webkitMatchesSelector,e.closest=e.closest||function(e){return this?this.matches(e)?this:this.parentElement?this.parentElement.closest(e):null:null}}(Element.prototype);var Dropdown=function(){function r(e,t,n){var i=document.createElement(e);return t&&(i.className=t),n&&(i.innerText=n),i}function o(e,t){if("object"===(void 0===e?"undefined":_typeof(e))||"string"==typeof t)return e.classList.contains(t)}function d(e,t){if(!t)return e;var n="щ   ш  ч  ц  ю  я  ё  ж  ъ  ы  э  а б в г д е з и й к л м н о п р с т у ф х ь".split(/ +/g),i="shh sh ch cz yu ya yo zh `` y' e` a b v g d e z i j k l m n o p r s t u f x `".split(/ +/g),s="o i x w . z \\ ; ] s ' f , d u l t p b q r k v y j g h c n e a [ m".split(/ +/g);switch(t){case"ru2en":for(var r=0;r<n.length;r++)e=e.split(n[r]).join(i[r]);return e;case"en2ru":for(var o=0;o<n.length;o++)e=e.split(i[o]).join(n[o]);return e;case"enBad2ru":for(var a=0;a<n.length;a++)e=e.split(s[a]).join(n[a]);return e;case"ruBad2en2ru":for(var l=0;l<n.length;l++)e=e.split(n[l]).join(s[l]);return d(e,"en2ru")}return e}return function(){function s(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{};if(_classCallCheck(this,s),"string"==typeof e){var n=document.querySelectorAll(e);if(0===n.length)return console.error("Dropdown: Селектор "+e+" не найден!"),!1;if(1<n.length)for(var i=1;i<n.length;i++)new s(n[i],t)}this.element="string"==typeof e?document.querySelector(e):e,this.options=Object.assign({},{avatar:!0,data:null,singleItem:!1,placeholder:"Введите имя друга или email",inputName:"dropdown",serverSearch:{url:null,fields:[]}},t),this.elements={target:this.element},this.selected=[],this._onClick=this._onClick.bind(this),this._onChange=this._onChange.bind(this),this._onClickDocument=this._onClickDocument.bind(this),this._init()}return _createClass(s,[{key:"_init",value:function(){this._createLayout(),this._render(),this._renderList(),this._addEventListeners()}},{key:"_createLayout",value:function(){var e=this.elements;e.wrapper=r("div","dropdown"),e.head=r("div","dropdown__head"),e.list=r("ul","dropdown__list"),e.tags=r("div","dropdown__tags"),e.input=r("input","dropdown__input"),e.input.setAttribute("placeholder",this.options.placeholder),e.input.setAttribute("type","text"),e.hidden=r("input"),e.hidden.setAttribute("name",this.options.inputName),e.hidden.setAttribute("type","hidden"),e.arrow=r("span","dropdown__arrow"),e.addButton=r("div","dropdown__add-button","Добавить")}},{key:"_createItem",value:function(e){var t=void 0,n=void 0;if(e){if(t=r("li","dropdown__item"),n=r("span","dropdown__name",e.name),t.setAttribute("data-id",e.id),this.options.avatar){var i=r("span","dropdown__avatar"),s=r("img","dropdown__avatar-img");s.setAttribute("src",e.avatar),i.appendChild(s),t.appendChild(i)}t.appendChild(n)}else t=r("li","dropdown__error","Пользователь не найден");return t}},{key:"_createTag",value:function(e){var t=r("div","dropdown__tag",e.name),n=r("button","dropdown__btn-remove");return t.setAttribute("data-id",e.id),t.appendChild(n),t}},{key:"_render",value:function(){var e=this.elements,t=e.target,n=e.wrapper,i=e.head,s=e.tags,r=e.input,o=e.hidden,a=e.arrow,l=(e.addButton,e.list);n.appendChild(i),n.appendChild(l),i.appendChild(s),i.appendChild(a),i.appendChild(r),i.appendChild(o),t.appendChild(n)}},{key:"_renderList",value:function(){var n=this,e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:this.options.data,t=this.elements.list,i=document.createDocumentFragment();if(t.innerHTML="",e.forEach(function(e){if(!(0<=n.selected.indexOf(e.id))){var t=n._createItem(e);i.appendChild(t)}}),t.appendChild(i),!t.children.length){var s=this._createItem(!1);t.appendChild(s)}}},{key:"_showListLoader",value:function(){var e=this.elements.list,t=r("li","dropdown__error","Загрузка...");e.innerHTML="",e.appendChild(t)}},{key:"_renderTags",value:function(){var n=this,i=this.elements.tags;i.innerHTML="",this.selected.forEach(function(t){var e=n.options.data.filter(function(e){return e.id==t})[0];i.appendChild(n._createTag(e))}),this.selected.length&&!this.options.singleItem&&i.appendChild(this.elements.addButton)}},{key:"_selectItem",value:function(e){0===this.selected.length&&this._hideInput(),this.elements.input.value="",this.selected.push(e),this._renderList(),this._renderTags(),this._updateHiddenInput()}},{key:"_unselect",value:function(t){this.selected=this.selected.filter(function(e){return e!==t}),this._renderList(),this._renderTags(),this._updateHiddenInput(),0===this.selected.length&&this._showInput()}},{key:"_addEventListeners",value:function(){var e=this.elements,t=e.wrapper,n=e.input;t.addEventListener("click",this._onClick),n.addEventListener("input",this._onChange),document.addEventListener("click",this._onClickDocument)}},{key:"_onClick",value:function(e){var t=e.target,n=t.closest(".dropdown__item");if(n&&(t=n),o(t,"dropdown__arrow")&&(o(this.elements.list,"active")?this.hideList():this.showList()),(o(t,"dropdown__input")||o(t,"dropdown__head")||o(t,"dropdown__tags"))&&this.showList(),n){var i=+t.getAttribute("data-id");this._selectItem(i),this.hideList()}if(o(t,"dropdown__btn-remove")){var s=+t.closest(".dropdown__tag").getAttribute("data-id");this._unselect(s)}o(t,"dropdown__add-button")&&this.showList()}},{key:"_onClickDocument",value:function(e){this.elements.wrapper.contains(e.target)||this.hideList()}},{key:"_onChange",value:function(e){this._filterList(e.target.value)}},{key:"_showInput",value:function(){this.elements.input.style.display="block",this.options.singleItem||(this.elements.addButton.style.display="none")}},{key:"_hideInput",value:function(){this.elements.input.style.display="none",this.options.singleItem||(this.elements.addButton.style.display="inline-block")}},{key:"_updateHiddenInput",value:function(){this.elements.hidden.value=this.selected.join(",")}},{key:"_filterList",value:function(e){if(""!==e){var t=this.options.data,n=e.toLowerCase(),i=[];i.push(n,d(n,"ru2en"),d(n,"en2ru"),d(n,"enBad2ru"),d(n,"ruBad2en2ru"));var s=t.filter(function(e){var t=e.name.toLowerCase(),n=t.split(" ");return n.push(t),n.some(function(t){return i.some(function(e){return!t.indexOf(e)})})});if(0===s.length&&"string"==typeof this.options.serverSearch.url){var r=this,o=new XMLHttpRequest,a="q="+encodeURIComponent(i.join(","))+"&fields="+encodeURIComponent(this.options.serverSearch.fields.join(","));return o.open("GET","api.php?"+a,!0),o.onloadstart=function(){r._showListLoader()},o.onload=function(){if(200<=this.status&&this.status<400){var e=JSON.parse(this.response);r._renderList(e)}},o.onerror=function(e){console.error(e)},void o.send()}this._renderList(s)}else this._renderList(t)}},{key:"showList",value:function(){if(!(this.options.singleItem&&0<this.selected)){var e=this.elements,t=e.list,n=e.input;t.classList.add("active"),n.focus(),0<this.selected.length&&this._showInput()}}},{key:"hideList",value:function(){this.elements.list.classList.remove("active"),0<this.selected.length&&""===this.elements.input.value&&this._hideInput()}}]),s}()}();